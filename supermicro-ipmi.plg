<?xml version="1.0" standalone="yes"?>
<PLUGIN name="supermicro-ipmi" author="ShunHax" version="0.0.1">
<FILE Run="/bin/bash" Method="install">
#!/bin/bash
mkdir -p /usr/local/emhttp/plugins/supermicro-ipmi

# Copy files from the plugin source directory
PLUGIN_SOURCE="/tmp/plugins/supermicro-ipmi"
if [ -d "$PLUGIN_SOURCE" ]; then
    echo "Copying files from $PLUGIN_SOURCE"
    cp -r "$PLUGIN_SOURCE"/* /usr/local/emhttp/plugins/supermicro-ipmi/
elif [ -d /tmp/supermicro-ipmi-plugin ]; then
    echo "Copying files from /tmp/supermicro-ipmi-plugin"
    cp -r /tmp/supermicro-ipmi-plugin/* /usr/local/emhttp/plugins/supermicro-ipmi/
else
    echo "No plugin files found, creating basic structure"
    # Create basic files if source not found
    cat > /usr/local/emhttp/plugins/supermicro-ipmi/plugin.php << 'EOF'
<?php
$plugin_name = "Supermicro BMC/IPMI Tool";
$plugin_description = "Manage IPMI compatible Supermicro motherboards with the IPMICFG utility.";
$plugin_version = "1.0.0";
$plugin_author = "ShunHax";
$plugin_support = "https://github.com/ShunHax/Unraid-Supermicro-BMC-IPMI-Tool";
?>
EOF
fi

# Remove the .plg file from the plugin directory
rm -f /usr/local/emhttp/plugins/supermicro-ipmi/supermicro-ipmi.plg

chmod +x /usr/local/emhttp/plugins/supermicro-ipmi/scripts/*.sh 2>/dev/null || true

mkdir -p /boot/config/plugins/supermicro-ipmi

if [ -f /usr/local/emhttp/plugins/supermicro-ipmi/images/icon.png ]; then
    cp /usr/local/emhttp/plugins/supermicro-ipmi/images/icon.png /boot/config/plugins/supermicro-ipmi/icon.png
fi

modprobe ipmi_msghandler 2>/dev/null || true
modprobe ipmi_devintf 2>/dev/null || true
modprobe ipmi_si 2>/dev/null || true

if [ -f /usr/local/emhttp/plugins/supermicro-ipmi/scripts/install_ipmicfg.sh ]; then
    /usr/local/emhttp/plugins/supermicro-ipmi/scripts/install_ipmicfg.sh
fi

if [ -f /usr/local/emhttp/plugins/supermicro-ipmi/scripts/monitor.sh ]; then
    echo "*/5 * * * * /usr/local/emhttp/plugins/supermicro-ipmi/scripts/monitor.sh" > /etc/cron.d/supermicro-ipmi
fi

echo "Supermicro IPMI plugin installed successfully!"
</FILE>
<FILE Run="/bin/bash" Method="remove">
#!/bin/bash
/etc/rc.d/rc.ipmiseld stop 2>/dev/null || true
rm -f /etc/cron.d/supermicro-ipmi
rm -rf /usr/local/emhttp/plugins/supermicro-ipmi
rm -rf /boot/config/plugins/supermicro-ipmi
modprobe -r ipmi_si 2>/dev/null || true
modprobe -r ipmi_devintf 2>/dev/null || true
modprobe -r ipmi_msghandler 2>/dev/null || true
echo "Supermicro IPMI plugin removed successfully!"
</FILE>
</PLUGIN> 